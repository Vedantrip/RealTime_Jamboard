<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jamboard Pro</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  
  <style>
    /* --- MODERN VARIABLES --- */
    :root {
      --primary: #2563eb;       /* Modern Blue */
      --primary-hover: #1d4ed8;
      --bg-color: #f8fafc;
      --surface: #ffffff;
      --text-main: #0f172a;
      --text-sub: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --radius: 12px;
    }

    * { box-sizing: border-box; outline: none; user-select: none; }
    body { margin: 0; overflow: hidden; background: var(--bg-color); font-family: 'Inter', sans-serif; color: var(--text-main); }

    /* --- 1. NEW LOGIN SCREEN (The Revamp) --- */
    #login-screen {
      position: fixed; inset: 0; z-index: 2000;
      display: flex; align-items: center; justify-content: center;
      /* Animated Mesh Gradient Background */
      background: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                  radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                  radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      background-size: 200% 200%;
      animation: gradientBG 15s ease infinite;
      background-color: #0f172a; /* Fallback dark */
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .login-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      width: 100%; max-width: 400px;
      padding: 48px 40px;
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .brand-icon {
      width: 64px; height: 64px; background: var(--primary); color: white;
      border-radius: 16px; display: inline-flex; align-items: center; justify-content: center;
      font-size: 32px; margin-bottom: 24px;
      box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
    }

    .login-title { font-size: 28px; font-weight: 700; margin: 0 0 8px 0; letter-spacing: -0.5px; }
    .login-sub { color: var(--text-sub); margin: 0 0 32px 0; font-size: 15px; }

    .input-group { position: relative; margin-bottom: 16px; text-align: left; }
    .input-group i {
      position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      color: var(--text-sub); font-size: 20px; transition: 0.2s;
    }
    
    .login-input {
      width: 100%; padding: 14px 16px 14px 48px; /* Padding left for icon */
      background: #f1f5f9; border: 2px solid transparent;
      border-radius: 12px; font-size: 15px; font-weight: 500;
      color: var(--text-main); transition: all 0.2s;
    }
    .login-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
    .login-input:focus + i { color: var(--primary); }

    .login-btn {
      width: 100%; padding: 16px; margin-top: 8px;
      background: var(--text-main); color: white;
      border: none; border-radius: 12px;
      font-weight: 600; font-size: 16px; cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s;
    }
    .login-btn:hover { background: #1e293b; transform: translateY(-1px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
    .login-btn:active { transform: translateY(0); }

    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }


    /* --- 2. MAIN APP UI --- */
    #app { display: none; } 

    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; padding: 16px 24px;
      display: flex; justify-content: space-between; align-items: center;
      pointer-events: none; z-index: 100;
    }
    
    .jam-title { 
      pointer-events: auto; background: white; padding: 10px 16px; border-radius: 12px;
      font-weight: 600; display: flex; align-items: center; gap: 10px; 
      box-shadow: var(--shadow-lg); border: 1px solid var(--border); font-size: 15px;
    }
    
    .slide-controls {
      pointer-events: auto; background: white; border-radius: 99px;
      box-shadow: var(--shadow-lg); display: flex; align-items: center; padding: 4px; border: 1px solid var(--border);
    }
    .slide-btn { background: transparent; border: none; width: 36px; height: 36px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .slide-btn:hover { background: var(--bg-color); }
    
    .actions { pointer-events: auto; display: flex; gap: 8px; }
    .action-btn {
      background: white; border: 1px solid var(--border); padding: 10px 16px;
      border-radius: 10px; box-shadow: var(--shadow-sm); cursor: pointer;
      font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px;
      transition: 0.2s; color: var(--text-main);
    }
    .action-btn:hover { background: var(--bg-color); transform: translateY(-1px); }

    /* TOOLBAR */
    .toolbar {
      position: fixed; left: 24px; top: 50%; transform: translateY(-50%);
      background: white; padding: 8px; border-radius: 16px;
      box-shadow: var(--shadow-lg); display: flex; flex-direction: column; gap: 8px;
      z-index: 100; border: 1px solid var(--border);
    }
    .tool-btn {
      width: 48px; height: 48px; border: none; background: transparent;
      border-radius: 10px; color: var(--text-sub); cursor: pointer; 
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; transition: 0.2s;
    }
    .tool-btn:hover { background: #eff6ff; color: var(--primary); }
    .tool-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

    /* CANVAS & LAYERS */
    #cursor-layer { position: fixed; inset: 0; pointer-events: none; z-index: 999; }
    .cursor { position: absolute; transition: transform 0.08s linear; pointer-events: none; will-change: transform; }
    .cursor-label { 
      background: var(--primary); color: white; padding: 4px 8px; border-radius: 6px; 
      font-size: 11px; font-weight: 600; margin-left: 12px; white-space: nowrap; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #canvas-wrap { position: absolute; top:0; left:0; width:100%; height:100%; background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px); background-size: 24px 24px; }
  </style>
</head>
<body>

  <div id="login-screen">
    <div class="login-card">
      <div class="brand-icon">
        <i class="ph-fill ph-pencil-simple-slash"></i>
      </div>
      <h1 class="login-title">Welcome Back</h1>
      <p class="login-sub">Enter your details to join the collaborative workspace.</p>
      
      <div class="input-group">
        <input id="name-input" class="login-input" placeholder="Your Name" value="Guest">
        <i class="ph ph-user"></i>
      </div>
      
      <div class="input-group">
        <input id="room-input" class="login-input" placeholder="Room Code (e.g. Design)" value="Apple">
        <i class="ph ph-hash"></i>
      </div>

      <button class="login-btn" onclick="joinRoom()">Enter Studio <i class="ph-bold ph-arrow-right" style="margin-left:8px"></i></button>
    </div>
  </div>

  <div id="app">
    <div class="top-bar">
      <div class="jam-title">
        <i class="ph-fill ph-shapes" style="color:var(--primary)"></i>
        <span>Untitled Board</span>
      </div>
      <div class="slide-controls">
        <button class="slide-btn" onclick="changeSlide(-1)"><i class="ph-bold ph-caret-left"></i></button>
        <span id="slide-indicator" style="width: 30px; text-align: center; font-weight:600; font-size:14px;">1</span>
        <button class="slide-btn" onclick="changeSlide(1)"><i class="ph-bold ph-caret-right"></i></button>
      </div>
      <div class="actions">
        <button class="action-btn" onclick="zoomToFit()"><i class="ph-bold ph-corners-out"></i> Fit</button>
        <button class="action-btn" onclick="deleteSelected()" style="color:#ef4444;"><i class="ph-bold ph-trash"></i></button>
        <button class="action-btn" onclick="clearBoard()" style="color:#ef4444;">Clear</button>
      </div>
    </div>

    <div class="toolbar">
      <button id="btn-select" class="tool-btn active" onclick="setTool('select')" title="Select (Alt+Drag to Pan)"><i class="ph-fill ph-cursor"></i></button>
      <button id="btn-pen" class="tool-btn" onclick="setTool('pen')" title="Draw"><i class="ph-fill ph-pen-nib"></i></button>
      <button id="btn-sticky" class="tool-btn" onclick="addSticky()" title="Sticky Note"><i class="ph-fill ph-sticky-note"></i></button>
      <button id="btn-text" class="tool-btn" onclick="addText()" title="Text"><i class="ph-fill ph-text-t"></i></button>
      <button id="btn-rect" class="tool-btn" onclick="addShape('rect')" title="Shape"><i class="ph-fill ph-square"></i></button>
    </div>

    <div id="cursor-layer"></div>
    <div id="canvas-wrap">
      <canvas id="c"></canvas>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let canvas; 
    let currentRoom = "", userName = "Guest", slide = 1;
    let isReceivingUpdate = false; 

    // --- APP LOGIC ---
    function joinRoom() {
      const roomVal = document.getElementById('room-input').value.trim();
      const nameVal = document.getElementById('name-input').value.trim();
      
      if(!roomVal) return alert("Please enter a room name");
      
      currentRoom = roomVal;
      userName = nameVal || "Guest";
      
      // Animate out
      const login = document.getElementById('login-screen');
      login.style.opacity = '0';
      login.style.transition = 'opacity 0.5s';
      setTimeout(() => {
        login.style.display = 'none';
        document.getElementById('app').style.display = 'block';
        initCanvas();
        socket.emit('join_room', currentRoom);
      }, 500);
    }

    function initCanvas() {
      canvas = new fabric.Canvas('c', { width: window.innerWidth, height: window.innerHeight, backgroundColor: null });
      window.addEventListener('resize', () => { canvas.setWidth(window.innerWidth); canvas.setHeight(window.innerHeight); });

      // Zoom/Pan
      canvas.on('mouse:wheel', function(opt) {
        var delta = opt.e.deltaY;
        var zoom = canvas.getZoom();
        zoom *= 0.999 ** delta;
        if (zoom > 5) zoom = 5; if (zoom < 0.1) zoom = 0.1;
        canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
        opt.e.preventDefault(); opt.e.stopPropagation();
      });

      let isDragging = false, lastX, lastY;
      canvas.on('mouse:down', function(opt) {
        if (opt.e.altKey === true || opt.e.button === 1) {
          isDragging = true; canvas.selection = false; lastX = opt.e.clientX; lastY = opt.e.clientY;
        }
      });
      canvas.on('mouse:move', function(opt) {
        if (isDragging) {
          var vpt = canvas.viewportTransform;
          vpt[4] += opt.e.clientX - lastX; vpt[5] += opt.e.clientY - lastY;
          canvas.requestRenderAll(); lastX = opt.e.clientX; lastY = opt.e.clientY;
        }
        const ptr = canvas.getPointer(opt.e);
        socket.emit('cursor_move', { room: currentRoom, user: userName, x: ptr.x, y: ptr.y });
      });
      canvas.on('mouse:up', function() { isDragging = false; canvas.selection = true; });

      // Object Events
      canvas.on('object:modified', (e) => socket.emit('object:update', { room: currentRoom, slide: slide, id: e.target.id, data: e.target.toJSON(['id']) }));
      canvas.on('object:added', (e) => {
        if (!isReceivingUpdate) {
          if(!e.target.id) e.target.set('id', Date.now() + '-' + Math.random());
          socket.emit('object:add', { room: currentRoom, slide: slide, data: e.target.toJSON(['id']) });
        }
      });
      canvas.on('object:removed', (e) => {
        if (!isReceivingUpdate) socket.emit('object:remove', { room: currentRoom, slide: slide, id: e.target.id });
      });
      canvas.on('path:created', (e) => { e.path.set('id', Date.now() + '-' + Math.random()); });
    }

    // Zoom to Fit logic
    function zoomToFit() {
      const objects = canvas.getObjects();
      if (objects.length === 0) { canvas.setViewportTransform([1,0,0,1,0,0]); return; }
      let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
      objects.forEach(o => {
        if(o.left < minX) minX = o.left;
        if(o.top < minY) minY = o.top;
        if(o.left + o.width * o.scaleX > maxX) maxX = o.left + o.width * o.scaleX;
        if(o.top + o.height * o.scaleY > maxY) maxY = o.top + o.height * o.scaleY;
      });
      const width = maxX - minX; const height = maxY - minY;
      const scale = Math.min((canvas.width-100)/width, (canvas.height-100)/height, 1);
      const vpt = canvas.viewportTransform;
      vpt[0]=scale; vpt[3]=scale;
      vpt[4]=(canvas.width - width*scale)/2 - minX*scale;
      vpt[5]=(canvas.height - height*scale)/2 - minY*scale;
      canvas.requestRenderAll();
    }

    // --- SOCKET SYNC ---
    socket.on('load_slide', (data) => {
      isReceivingUpdate = true;
      slide = data.slide;
      document.getElementById('slide-indicator').innerText = slide;
      canvas.clear(); canvas.backgroundColor = null; 
      fabric.util.enlivenObjects(data.history, (objs) => {
        objs.forEach((o) => canvas.add(o));
        isReceivingUpdate = false;
        setTimeout(zoomToFit, 100);
      });
    });

    socket.on('object:add', (data) => { if(data.slide===slide) { isReceivingUpdate=true; fabric.util.enlivenObjects([data.data],(o)=>{canvas.add(o[0]); isReceivingUpdate=false;}); }});
    socket.on('object:update', (data) => { if(data.slide===slide) { isReceivingUpdate=true; const o=canvas.getObjects().find(obj=>obj.id===data.id); if(o){o.set(data.data); o.setCoords(); canvas.requestRenderAll();} isReceivingUpdate=false; }});
    socket.on('object:remove', (data) => { if(data.slide===slide) { isReceivingUpdate=true; const o=canvas.getObjects().find(obj=>obj.id===data.id); if(o)canvas.remove(o); isReceivingUpdate=false; }});
    socket.on('clear_board', () => { isReceivingUpdate=true; canvas.clear(); isReceivingUpdate=false; });
    
    socket.on('cursor_update', (d) => {
      const l = document.getElementById('cursor-layer');
      let c = document.getElementById(`cur-${d.id}`);
      if (!c) { c = document.createElement('div'); c.id = `cur-${d.id}`; c.className = 'cursor'; c.innerHTML = `<i class="ph-fill ph-cursor" style="color:#2563eb; font-size:24px; transform:rotate(-20deg);"></i><span class="cursor-label">${d.user}</span>`; l.appendChild(c); }
      const p = fabric.util.transformPoint({x:d.x, y:d.y}, canvas.viewportTransform);
      c.style.transform = `translate(${p.x}px, ${p.y}px)`;
    });

    // --- TOOLS ---
    function setTool(t) { canvas.isDrawingMode=(t==='pen'); if(t==='pen'){canvas.freeDrawingBrush.width=4; canvas.freeDrawingBrush.color="#0f172a";} document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+t).classList.add('active'); }
    function addSticky() { const c = canvas.getVpCenter(); const note = new fabric.Group([new fabric.Rect({width:150,height:150,fill:'#fef08a', rx:4, ry:4, shadow:'rgba(0,0,0,0.1) 5px 5px 10px'}), new fabric.Textbox('Idea...',{fontSize:18,width:130,top:20,left:10, fontFamily:'Inter', splitByGrapheme: true})], {left:c.x-75,top:c.y-75}); canvas.add(note); canvas.setActiveObject(note); }
    function addText() { const c = canvas.getVpCenter(); canvas.add(new fabric.IText('Type here...', {left:c.x,top:c.y, fontFamily:'Inter', fontSize:24})); }
    function addShape() { const c = canvas.getVpCenter(); canvas.add(new fabric.Rect({width:100,height:100,fill:'transparent',stroke:'#2563eb',strokeWidth:3,left:c.x,top:c.y})); }
    function deleteSelected() { canvas.getActiveObjects().forEach((o)=>canvas.remove(o)); }
    function clearBoard() { if(confirm('Clear entire board?')) { canvas.clear(); socket.emit('clear_board', {room:currentRoom, slide:slide}); } }
    function changeSlide(dir) { const next = slide + dir; if(next>0) socket.emit('change_slide', {room:currentRoom, slide:next}); }
  </script>
</body>
</html>